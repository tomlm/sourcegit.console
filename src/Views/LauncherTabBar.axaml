<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:SourceGit.ViewModels"
             xmlns:c="using:SourceGit.Converters"
             xmlns:v="using:SourceGit.Views"
             xmlns:console="https://github.com/jinek/consolonia"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="SourceGit.Views.LauncherTabBar"
             x:DataType="vm:Launcher"
             x:Name="ThisControl">
  <Grid ColumnDefinitions="{console:OnPlatform Default='Auto,*,Auto', Console='Auto,*,Auto'}">
    <RepeatButton Grid.Column="0"
                  Classes="icon_button"
                  Width="{console:OnPlatform Default='18', Console='1'}" Height="{console:OnPlatform Default='30', Console='3'}"
                  Click="ScrollTabsLeft"
                  IsVisible="{Binding #ThisControl.IsScrollerVisible}">
      <console:OnPlatform>
                <console:OnPlatform.Default>
                  <Path Width="{console:OnPlatform Default='8', Console='1'}" Height="{console:OnPlatform Default='14', Console='1'}" Stretch="Fill" Data="{StaticResource Icons.TriangleLeft}"/>
                </console:OnPlatform.Default>
                <console:OnPlatform.Console>
                  <TextBlock Text="◀"/>
      </console:OnPlatform.Console>
      </console:OnPlatform>
    </RepeatButton>

    <ScrollViewer Grid.Column="1"
                  Margin="{console:OnPlatform Default='6,0', Console='1,0'}"
                  x:Name="LauncherTabsScroller"
                  HorizontalAlignment="Left"
                  HorizontalScrollBarVisibility="Hidden"
                  VerticalScrollBarVisibility="Disabled"
                  PointerWheelChanged="ScrollTabs">
      <StackPanel Orientation="Horizontal">
        <ListBox x:Name="LauncherTabsList"
                 Classes="launcher_page_tabbar"
                 ItemsSource="{Binding Pages}"
                 SelectionMode="AlwaysSelected"
                 SelectedItem="{Binding ActivePage, Mode=TwoWay}"
                 SelectionChanged="OnTabsSelectionChanged"
                 LayoutUpdated="OnTabsLayoutUpdated">
          <ListBox.ItemsPanel>
            <ItemsPanelTemplate>
              <StackPanel Orientation="Horizontal" Height="{console:OnPlatform Default='30', Console='3'}"/>
            </ItemsPanelTemplate>
          </ListBox.ItemsPanel>

          <ListBox.ItemTemplate>
            <DataTemplate DataType="vm:LauncherPage">
              <Border Height="{console:OnPlatform Default='30', Console='3'}"
                      Background="Transparent"
                      PointerPressed="OnPointerPressedTab"
                      PointerMoved="OnPointerMovedOverTab"
                      PointerReleased="OnPointerReleasedTab"
                      Loaded="SetupDragAndDrop"
                      ContextRequested="OnTabContextRequested">
                <ToolTip.Tip>
                  <Grid>
                    <TextBlock Text="{DynamicResource Text.Welcome}" IsVisible="{Binding !Node.IsRepository}"/>
                    <TextBlock Text="{Binding Node.Id}" IsVisible="{Binding Node.IsRepository}"/>
                  </Grid>
                </ToolTip.Tip>

                <Grid Width="{Binding Source={x:Static vm:Preferences.Instance}, Path=UseFixedTabWidth, Converter={x:Static c:BoolConverters.ToPageTabWidth}}" Height="{console:OnPlatform Default='30', Console='3'}" ColumnDefinitions="{console:OnPlatform Default='Auto,*,Auto', Console='Auto,*,Auto'}" VerticalAlignment="Center">
                  <console:OnPlatform>
                                        <console:OnPlatform.Default>
                                          <Path Grid.Column="0"
                                                Width="{console:OnPlatform Default='12', Console='1'}" Height="{console:OnPlatform Default='12', Console='1'}" Margin="{console:OnPlatform Default='12,0', Console='1,0'}"
                                                Fill="{Binding Node.Bookmark, Converter={x:Static c:IntConverters.ToBookmarkBrush}}"
                                                Data="{StaticResource Icons.Bookmark}"
                                                IsVisible="{Binding Node.IsRepository}"
                                                IsHitTestVisible="False"/>
                                        </console:OnPlatform.Default>
                                        <console:OnPlatform.Console>
                                          <TextBlock Text="★"/>
                  </console:OnPlatform.Console>
                  </console:OnPlatform>
                  <console:OnPlatform>
                                        <console:OnPlatform.Default>
                                          <Path Grid.Column="0"
                                                Width="{console:OnPlatform Default='12', Console='1'}" Height="{console:OnPlatform Default='12', Console='1'}" Margin="{console:OnPlatform Default='12,0', Console='1,0'}"
                                                Fill="{DynamicResource Brush.FG1}"
                                                Data="{StaticResource Icons.Repositories}"
                                                IsVisible="{Binding !Node.IsRepository}"
                                                IsHitTestVisible="False"/>
                                        </console:OnPlatform.Default>
                                        <console:OnPlatform.Console>
                                          <TextBlock Text="📁"/>
                  </console:OnPlatform.Console>
                  </console:OnPlatform>

                  <Grid Grid.Column="1"
                        HorizontalAlignment="Center" VerticalAlignment="Center"
                        ColumnDefinitions="{console:OnPlatform Default='Auto,*', Console='Auto,*'}"
                        IsHitTestVisible="False"
                        IsVisible="{Binding Node.IsRepository}">
                    <Ellipse Grid.Column="0"
                             Width="{console:OnPlatform Default='8', Console='1'}" Height="{console:OnPlatform Default='8', Console='1'}"
                             Margin="{console:OnPlatform Default='0,0,6,0', Console='0,0,1,0'}"
                             VerticalAlignment="Center"
                             IsVisible="{Binding DirtyBrush, Converter={x:Static ObjectConverters.IsNotNull}}"
                             Fill="{Binding DirtyBrush}"/>

                    <TextBlock Grid.Column="1"
                               Classes="primary"
                               VerticalAlignment="Center"
                               FontSize="{Binding Source={x:Static vm:Preferences.Instance}, Path=DefaultFontSize, Converter={x:Static c:DoubleConverters.Decrease}}"
                               TextAlignment="Center"
                               Text="{Binding Node.Name}"
                               IsHitTestVisible="False"/>
                  </Grid>

                  <TextBlock Grid.Column="1"
                             Classes="primary"
                             HorizontalAlignment="Stretch" VerticalAlignment="Center"
                             FontSize="{Binding Source={x:Static vm:Preferences.Instance}, Path=DefaultFontSize, Converter={x:Static c:DoubleConverters.Decrease}}"
                             TextAlignment="Center"
                             Text="{DynamicResource Text.PageTabBar.Welcome.Title}"
                             IsVisible="{Binding !Node.IsRepository}"
                             IsHitTestVisible="False"/>

                  <Button Grid.Column="2"
                          Classes="icon_button"
                          Width="{console:OnPlatform Default='16', Console='1'}" Height="{console:OnPlatform Default='16', Console='1'}" Margin="{console:OnPlatform Default='12,0', Console='1,0'}"
                          Click="OnCloseTab">
                    <ToolTip.Tip>
                      <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="{DynamicResource Text.PageTabBar.Tab.Close}" VerticalAlignment="Center"/>
                        <TextBlock Margin="{console:OnPlatform Default='16,0,0,0', Console='1,0,0,0'}"
                                   Text="{OnPlatform Ctrl+W, macOS=⌘+W}"
                                   FontSize="11"
                                   VerticalAlignment="Center"
                                   Foreground="{DynamicResource MenuFlyoutItemKeyboardAcceleratorTextForeground}"/>
                      </StackPanel>
                    </ToolTip.Tip>
                    <console:OnPlatform>
                                            <console:OnPlatform.Default>
                                              <Path Width="{console:OnPlatform Default='9', Console='1'}" Height="{console:OnPlatform Default='9', Console='1'}" Data="{StaticResource Icons.Close}"/>
                                            </console:OnPlatform.Default>
                                            <console:OnPlatform.Console>
                                              <TextBlock Text="✕"/>
                    </console:OnPlatform.Console>
                    </console:OnPlatform>
                  </Button>
                </Grid>
              </Border>
            </DataTemplate>
          </ListBox.ItemTemplate>
        </ListBox>

        <Button Classes="icon_button"
                Width="{console:OnPlatform Default='16', Console='1'}" Height="{console:OnPlatform Default='16', Console='1'}"
                Margin="{console:OnPlatform Default='8,0', Console='1,0'}"
                Command="{Binding AddNewTab}"
                IsVisible="{Binding !#ThisControl.IsScrollerVisible}">
          <ToolTip.Tip>
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
              <TextBlock Text="{DynamicResource Text.PageTabBar.New}" VerticalAlignment="Center"/>
              <TextBlock Margin="{console:OnPlatform Default='16,0,0,0', Console='1,0,0,0'}"
                         Text="{OnPlatform Ctrl+T, macOS=⌘+T}"
                         FontSize="11"
                         VerticalAlignment="Center"
                         Foreground="{DynamicResource MenuFlyoutItemKeyboardAcceleratorTextForeground}"/>
            </StackPanel>
          </ToolTip.Tip>
          <console:OnPlatform>
                        <console:OnPlatform.Default>
                          <Path Width="{console:OnPlatform Default='12', Console='1'}" Height="{console:OnPlatform Default='12', Console='1'}" Data="{StaticResource Icons.Plus}"/>
                        </console:OnPlatform.Default>
                        <console:OnPlatform.Console>
                          <TextBlock Text="+"/>
          </console:OnPlatform.Console>
          </console:OnPlatform>
        </Button>
      </StackPanel>
    </ScrollViewer>

    <StackPanel Grid.Column="2" Orientation="Horizontal" IsVisible="{Binding #ThisControl.IsScrollerVisible}">
      <RepeatButton Classes="icon_button" Width="{console:OnPlatform Default='18', Console='1'}" Height="{console:OnPlatform Default='30', Console='3'}" Click="ScrollTabsRight">
        <console:OnPlatform>
                    <console:OnPlatform.Default>
                      <Path Width="{console:OnPlatform Default='8', Console='1'}" Height="{console:OnPlatform Default='14', Console='1'}" Stretch="Fill" Data="{StaticResource Icons.TriangleRight}"/>
                    </console:OnPlatform.Default>
                    <console:OnPlatform.Console>
                      <TextBlock Text="▶"/>
        </console:OnPlatform.Console>
        </console:OnPlatform>
      </RepeatButton>

      <Button x:Name="PageSelector" Classes="icon_button" Width="{console:OnPlatform Default='16', Console='1'}" Height="{console:OnPlatform Default='16', Console='1'}" Margin="{console:OnPlatform Default='8,0', Console='1,0'}">
        <Button.Flyout>
          <Flyout Opened="OnTabsDropdownOpened" Closed="OnTabsDropdownClosed">
            <Grid RowDefinitions="{console:OnPlatform Default='28,Auto', Console='3,Auto'}" KeyDown="OnTabsDropdownKeyDown" LostFocus="OnTabsDropdownLostFocus">
              <TextBox Grid.Row="0"
                       Height="{console:OnPlatform Default='24', Console='2'}"
                       Margin="{console:OnPlatform Default='4,0', Console='1,0'}"
                       BorderThickness="1"
                       CornerRadius="{console:OnPlatform Default='12', Console='0'}"
                       Text="{Binding #ThisControl.SearchFilter, Mode=TwoWay}"
                       BorderBrush="{DynamicResource Brush.Border2}"
                       VerticalContentAlignment="Center"
                       KeyDown="OnTabsDropdownSearchBoxKeyDown"
                       v:AutoFocusBehaviour.IsEnabled="True">
                <TextBox.InnerLeftContent>
                  <console:OnPlatform>
                                        <console:OnPlatform.Default>
                                          <Path Width="{console:OnPlatform Default='14', Console='1'}" Height="{console:OnPlatform Default='14', Console='1'}"
                                                Margin="{console:OnPlatform Default='6,0,0,0', Console='1,0,0,0'}"
                                                Fill="{DynamicResource Brush.FG2}"
                                                Data="{StaticResource Icons.Search}"/>
                                        </console:OnPlatform.Default>
                                        <console:OnPlatform.Console>
                                          <TextBlock Text="🔍"/>
                  </console:OnPlatform.Console>
                  </console:OnPlatform>
                </TextBox.InnerLeftContent>

                <TextBox.InnerRightContent>
                  <Button Classes="icon_button"
                          Width="{console:OnPlatform Default='16', Console='1'}"
                          Margin="{console:OnPlatform Default='0,0,6,0', Console='0,0,1,0'}"
                          Click="OnClearSearchFilter"
                          IsVisible="{Binding #ThisControl.SearchFilter, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                          HorizontalAlignment="Right">
                    <console:OnPlatform>
                                            <console:OnPlatform.Default>
                                              <Path Width="{console:OnPlatform Default='14', Console='1'}" Height="{console:OnPlatform Default='14', Console='1'}"
                                                    Margin="{console:OnPlatform Default='0,1,0,0', Console='0,1,0,0'}"
                                                    Fill="{DynamicResource Brush.FG1}"
                                                    Data="{StaticResource Icons.Clear}"/>
                                            </console:OnPlatform.Default>
                                            <console:OnPlatform.Console>
                                              <TextBlock Text="✕"/>
                    </console:OnPlatform.Console>
                    </console:OnPlatform>
                  </Button>
                </TextBox.InnerRightContent>
              </TextBox>

              <ListBox Grid.Row="1"
                       x:Name="TabsDropdownList"
                       Focusable="True"
                       Width="{console:OnPlatform Default='200', Console='20'}"
                       MaxHeight="{console:OnPlatform Default='400', Console='40'}"
                       Margin="{console:OnPlatform Default='0,4,0,0', Console='0,1,0,0'}"
                       Background="Transparent"
                       SelectionMode="Single"
                       ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                       ScrollViewer.VerticalScrollBarVisibility="Auto"
                       ItemsSource="{Binding #ThisControl.SelectablePages}"
                       SelectedItem="{Binding ActivePage, Mode=OneWay}">
                <ListBox.Styles>
                  <Style Selector="ListBoxItem">
                    <Setter Property="Padding" Value="{console:OnPlatform Default='0', Console='0'}"/>
                    <Setter Property="MinHeight" Value="{console:OnPlatform Default='26', Console='2'}"/>
                    <Setter Property="CornerRadius" Value="{console:OnPlatform Default='4', Console='0'}"/>
                  </Style>

                  <Style Selector="ListBox">
                    <Setter Property="FocusAdorner">
                      <FocusAdornerTemplate>
                        <Grid/>
                      </FocusAdornerTemplate>
                    </Setter>
                  </Style>
                </ListBox.Styles>

                <ListBox.ItemsPanel>
                  <ItemsPanelTemplate>
                    <StackPanel Orientation="Vertical"/>
                  </ItemsPanelTemplate>
                </ListBox.ItemsPanel>

                <ListBox.ItemTemplate>
                  <DataTemplate DataType="vm:LauncherPage">
                    <Grid ColumnDefinitions="{console:OnPlatform Default='Auto,*', Console='Auto,*'}" Background="Transparent" Tapped="OnTabsDropdownItemTapped">
                      <console:OnPlatform>
                                                <console:OnPlatform.Default>
                                                  <Path Grid.Column="0"
                                                        Width="{console:OnPlatform Default='12', Console='1'}" Height="{console:OnPlatform Default='12', Console='1'}" Margin="{console:OnPlatform Default='12,0', Console='1,0'}"
                                                        Fill="{Binding Node.Bookmark, Converter={x:Static c:IntConverters.ToBookmarkBrush}}"
                                                        Data="{StaticResource Icons.Bookmark}"
                                                        IsVisible="{Binding Node.IsRepository}"
                                                        IsHitTestVisible="False"/>
                                                </console:OnPlatform.Default>
                                                <console:OnPlatform.Console>
                                                  <TextBlock Text="★"/>
                      </console:OnPlatform.Console>
                      </console:OnPlatform>
                      <console:OnPlatform>
                                                <console:OnPlatform.Default>
                                                  <Path Grid.Column="0"
                                                        Width="{console:OnPlatform Default='12', Console='1'}" Height="{console:OnPlatform Default='12', Console='1'}" Margin="{console:OnPlatform Default='12,0', Console='1,0'}"
                                                        Fill="{DynamicResource Brush.FG1}"
                                                        Data="{StaticResource Icons.Repositories}"
                                                        IsVisible="{Binding !Node.IsRepository}"
                                                        IsHitTestVisible="False"/>
                                                </console:OnPlatform.Default>
                                                <console:OnPlatform.Console>
                                                  <TextBlock Text="📁"/>
                      </console:OnPlatform.Console>
                      </console:OnPlatform>
                      <TextBlock Grid.Column="1"
                                 Classes="primary"
                                 VerticalAlignment="Center"
                                 Text="{Binding Node.Name}"
                                 IsVisible="{Binding Node.IsRepository}"
                                 IsHitTestVisible="False"/>
                      <TextBlock Grid.Column="1"
                                 Classes="primary"
                                 VerticalAlignment="Center"
                                 Text="{DynamicResource Text.PageTabBar.Welcome.Title}"
                                 IsVisible="{Binding !Node.IsRepository}"
                                 IsHitTestVisible="False"/>
                    </Grid>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
            </Grid>
          </Flyout>
        </Button.Flyout>
        <console:OnPlatform>
                    <console:OnPlatform.Default>
                      <Path Width="{console:OnPlatform Default='14', Console='1'}" Height="{console:OnPlatform Default='14', Console='1'}" Data="{StaticResource Icons.CircleDown}"/>
                    </console:OnPlatform.Default>
                    <console:OnPlatform.Console>
                      <TextBlock Text="⬇"/>
        </console:OnPlatform.Console>
        </console:OnPlatform>
      </Button>

      <Button Classes="icon_button" Width="{console:OnPlatform Default='16', Console='1'}" Height="{console:OnPlatform Default='16', Console='1'}" Command="{Binding AddNewTab}">
        <ToolTip.Tip>
          <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
            <TextBlock Text="{DynamicResource Text.PageTabBar.New}" VerticalAlignment="Center"/>
            <TextBlock Margin="{console:OnPlatform Default='16,0,0,0', Console='1,0,0,0'}"
                       Text="{OnPlatform Ctrl+T, macOS=⌘+T}"
                       FontSize="11"
                       VerticalAlignment="Center"
                       Foreground="{DynamicResource MenuFlyoutItemKeyboardAcceleratorTextForeground}"/>
          </StackPanel>
        </ToolTip.Tip>
        <console:OnPlatform>
                    <console:OnPlatform.Default>
                      <Path Width="{console:OnPlatform Default='12', Console='1'}" Height="{console:OnPlatform Default='12', Console='1'}" Data="{StaticResource Icons.Plus}"/>
                    </console:OnPlatform.Default>
                    <console:OnPlatform.Console>
                      <TextBlock Text="+"/>
        </console:OnPlatform.Console>
        </console:OnPlatform>
      </Button>
    </StackPanel>
  </Grid>
</UserControl>


